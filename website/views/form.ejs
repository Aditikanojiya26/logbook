<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shift Form</title>
</head>

<body>

    <h3><%= phase %> Parameters</h3>
 <form id="shiftForm">
    <input type="hidden" id="phase" value="<%= phase %>">
  
  

  <% parameters.forEach(param => { %>
    <div>
      <label><%= param.name %> (<%= param.unit || '' %>)</label><br>

      <% if (param.inputType === "select") { %>
        <select name="parameters[<%= param.name %>]">
          <% param.options.forEach(opt => { %>
            <option value="<%= opt %>"><%= opt %></option>
          <% }) %>
        </select>

      <% } else if (param.inputType === "checkbox") { %>
        <% param.options.forEach(opt => { %>
          <label>
            <input type="checkbox" name="parameters[<%= param.name %>][]" value="<%= opt %>"> <%= opt %>
          </label>
        <% }) %>

      <% } else { %>
        <input type="<%= param.inputType %>" name="parameters[<%= param.name %>]">
      <% } %>
    </div><br>
  <% }) %>

  <!-- Render auxiliaries only if shiftBeginning -->
  <% if (phase === "shiftBeginning") { %>
    <h4>In-Service Auxiliaries</h4>
   
    <% auxiliaries.forEach(aux => { %>
        <div class="auxiliary" data-auxiliary-id="<%= aux._id %>" data-auxiliary-name="<%= aux.name %>">
          <h3><%= aux.name %></h3>
          <% aux.options.forEach(option => { %>
            <label>
              <%= option.optionName %>: <%= option.status %>
              <% if (option.status === 'Ready') { %>
                <input type="checkbox" value="<%= option.optionName %>">
              <% } %>
            </label>
          <% }) %>
        </div>
      <% }) %>
      
  <% } %>

        <br>
        <button type="submit">Submit</button>
    </form>

</body>
<script>
    document.getElementById("shiftForm").addEventListener("submit", async function(e) {
      e.preventDefault();
    
      const phase = document.getElementById("phase").value;
      const parameters = [];
    
      // Get parameter values
      document.querySelectorAll("[name^='parameters']").forEach(input => {
        const match = input.name.match(/parameters\[(.+?)\]/);
        if (!match) return;
        const name = match[1];
        let value;
    
        if (input.type === "checkbox") {
          if (!input.checked) return;
          const existing = parameters.find(p => p.name === name);
          if (existing) {
            existing.value.push(input.value);
          } else {
            parameters.push({ name, value: [input.value] });
          }
        } else if (input.tagName === "SELECT") {
          parameters.push({ name, value: input.value });
        } else {
          parameters.push({ name, value: input.value });
        }
      });
    
      // Get auxiliary selections
      const auxiliaries = [];
      document.querySelectorAll(".auxiliary").forEach(auxDiv => {
        const auxiliaryId = auxDiv.dataset.auxiliaryId;
        const auxiliaryName = auxDiv.dataset.auxiliaryName;
        const selectedOptions = Array.from(auxDiv.querySelectorAll("input[type='checkbox']:checked"))
                                     .map(cb => cb.value);
        if (selectedOptions.length > 0) {
          auxiliaries.push({
            auxiliaryId,
            auxiliaryName,
            selectedOptions
          });
        }
      });
    
      const body = {
        phase,
        parameters,
        inServiceAuxiliaries: auxiliaries
      };
    
      try {
        const res = await fetch("/submit-shift", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
    
        const result = await res.json();
        alert(result.msg);
      } catch (err) {
        console.error("Submission failed", err);
        alert("Error submitting form");
      }
    });
    </script>
    
</html>
